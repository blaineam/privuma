FROM php:8.1-fpm AS base

WORKDIR /var/www/html

# Install ALL dependencies from apt - no source compilation
RUN apt-get update && apt-get upgrade -y && apt-get install -y \
    # Basic tools
    locales zip unzip vim git graphviz curl supervisor htop wget \
    # Image optimization tools
    jpegoptim optipng pngquant gifsicle \
    # WebP tools (cwebp, dwebp, gif2webp, img2webp, webpmux)
    webp \
    # ImageMagick with HEIF/WebP/AVIF support
    imagemagick libmagickwand-dev ghostscript \
    # FFmpeg for video processing
    ffmpeg \
    # Libraries for PHP extensions
    libpng-dev libjpeg62-turbo-dev libfreetype6-dev libzip-dev \
    libonig-dev zlib1g-dev libcurl4-openssl-dev libicu-dev \
    # Other tools
    cpulimit percona-toolkit libimage-exiftool-perl ocrmypdf \
    # Java runtime
    default-jre-headless \
    # Python
    python3 python3-pip \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install php-extension-installer (handles cross-arch builds properly)
ADD --chmod=0755 https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/

# Install all PHP extensions via install-php-extensions (avoids QEMU crashes)
RUN install-php-extensions gd mysqli pdo_mysql zip exif pcntl intl \
    sysvmsg sysvsem sysvshm imagick redis

# Install Python packages
RUN pip3 install --break-system-packages \
    beautifulsoup4 requests tqdm yt-dlp requests-doh 'gdown>=5.1.0' gallery-dl

# Install megatools (prebuilt binary)
RUN ARCH=$(uname -m) && \
    curl -L "https://xff.cz/megatools/builds/builds/megatools-1.11.4.20250411-linux-${ARCH}.tar.gz" -o megatools.tar.gz && \
    tar -xzf megatools.tar.gz && \
    cp megatools-1.11.4.20250411-linux-${ARCH}/megatools /usr/local/bin/megatools && \
    rm -rf megatools-1.11.4.20250411-linux-${ARCH} megatools.tar.gz

# Install rclone (prebuilt binary)
RUN curl https://rclone.org/install.sh | bash

# Install Ruffle (prebuilt binary from GitHub releases)
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then RUFFLE_ARCH="x86_64"; else RUFFLE_ARCH="aarch64"; fi && \
    RUFFLE_DATE_TAG=$(date -u +%Y-%m-%d) && \
    RUFFLE_DATE_FILE=$(date -u +%Y_%m_%d) && \
    curl -fL "https://github.com/ruffle-rs/ruffle/releases/download/nightly-${RUFFLE_DATE_TAG}/ruffle-nightly-${RUFFLE_DATE_FILE}-linux-${RUFFLE_ARCH}.tar.gz" -o ruffle.tar.gz || \
    curl -fL "https://github.com/ruffle-rs/ruffle/releases/download/nightly-2025-01-01/ruffle-nightly-2025_01_01-linux-${RUFFLE_ARCH}.tar.gz" -o ruffle.tar.gz && \
    tar -xzf ruffle.tar.gz && \
    install ruffle /usr/local/bin/ruffle && \
    rm -f ruffle.tar.gz ruffle LICENSE.md README.md && \
    ruffle --version

# Configure ImageMagick policies
RUN sed -i 's%<policy domain="coder" rights="none" pattern="PDF" />%<policy domain="coder" rights="read|write" pattern="PDF" />%g' /etc/ImageMagick-6/policy.xml 2>/dev/null || true && \
    sed -i 's%<policy domain="resource" name="disk" value="1GiB"/>%<policy domain="resource" name="disk" value="8GiB"/>%g' /etc/ImageMagick-6/policy.xml 2>/dev/null || true && \
    sed -i 's%<policy domain="resource" name="area" value="128MP"/>%<policy domain="resource" name="area" value="512MP"/>%g' /etc/ImageMagick-6/policy.xml 2>/dev/null || true && \
    sed -i 's%<policy domain="resource" name="memory" value="256MiB"/>%<policy domain="resource" name="memory" value="1GiB"/>%g' /etc/ImageMagick-6/policy.xml 2>/dev/null || true

# Create symlink so 'magick' command works (IM6 uses 'convert')
RUN ln -sf /usr/bin/convert /usr/bin/magick

# Configure user
ARG USERID=1000
RUN usermod -u ${USERID} www-data || true
RUN chsh -s /bin/bash www-data

RUN echo 'request_terminate_timeout = 10s' >> /usr/local/etc/php-fpm.d/zz-docker.conf

# Verify key tools are installed
RUN cwebp -version && gif2webp -version && convert -version && ffmpeg -version

CMD ["php-fpm"]

# Production image
FROM cenode/privuma-php AS prod

ARG USERID=1000
RUN usermod -u ${USERID} www-data || true
RUN chsh -s /bin/bash www-data

ARG PHP_PORT=9701
RUN sed -i "s/9000/${PHP_PORT}/g" /usr/local/etc/php-fpm.d/www.conf
RUN sed -i "s/9000/${PHP_PORT}/g" /usr/local/etc/php-fpm.d/zz-docker.conf

EXPOSE ${PHP_PORT}

RUN mkdir -p /var/www/.cache && chown www-data /var/www/.cache
